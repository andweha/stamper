{% extends "layout.html" %}
{% block content %}
<main class="main-container">
  <div class="content-layout">
  <!-- MEDIA CONTAINER -->
  <div class="Container media-container">
    <div class="Details">
      <div class="title-poster">
        <h2>
          {% if media_type == 'episode' %}
            Episode {{ media.episode_number }}: {{ media.episode_name }}
          {% elif media_type == 'anime_episode' %}
            {{ media.episode_title }}
          {% else %}
            {{ media.title }}
          {% endif %}
        </h2>
        {% if media.still_url or media.thumbnail or media.poster_url %}
          <img src="{{ media.still_url or media.thumbnail or media.poster_url }}" alt="{{ media.episode_name or media.episode_title or media.title }}">
        {% endif %}
        <p><strong>Air Date:</strong> {{ media.air_date if media_type == 'episode' else media.release_date }}</p>
        <p><strong>Rating:</strong> {{ media.vote_average }}</p>
      </div>

      <div class="Overview">
        {% if media_type != 'anime_episode' %}
          <p>{{ media.overview }}</p>
        {% endif %}
        {% if emoji_summary %}
          <p><strong>General Viewer Reaction:</strong> {{ emoji_summary }}</p>
        {% endif %}
      </div>
    </div>

    <hr>

    <div class="player">
      <button id="play-btn" type="button" class="play-btn" aria-label="Play">â–¶</button>
      <div id="progress-container"
           class="progress-container"
           data-duration="{{ media.duration * 60 if media_type == 'anime_episode' and media.duration is not none else media.runtime * 60 if media.runtime is not none else 3600 }}">
        <div id="progress-bar" class="progress-bar"></div>
        <span id="progress-tooltip" class="progress-tooltip"></span>
      </div>
    </div>
  </div>

  <!-- COMMENT CONTAINER -->
  <div class="Container comment-container">
    <div class="comments-header">
      <h3>Comments</h3>
    </div>

    <div class="comment-wrapper">
      <div class="comment-feed" id="comments-container">
        {% for comment in comments %}
        <div class="comment" data-secs="{{ comment.timestamp }}">
          <div class="comment-header">
            <strong>{{ comment.user.username }}</strong>
            <code>{{ "%02d:%02d:%02d"|format(comment.timestamp // 3600, (comment.timestamp % 3600) // 60, comment.timestamp % 60) }}</code>
          </div>
          <div class="comment-body">
            {% if comment.content %}<p>{{ comment.content }}</p>{% endif %}
            {% if comment.gif_url %}<img src="{{ comment.gif_url }}" alt="GIF" width="160">{% endif %}
          </div>
        </div>
        {% endfor %}
      </div>

      {% if current_user.is_authenticated %}
      <form method="POST" class="comment-input-form">
        {{ form.hidden_tag() }}

        <div class="comment-input-fields">
          <div class="timestamp-field">
            {{ form.timestamp.label }}<br>
            {{ form.timestamp(size=10, placeholder="e.g., 01:23:45") }}
            {% for error in form.timestamp.errors %}
              <p class="form-error">{{ error }}</p>
            {% endfor %}
          </div>

          <div class="text-field comment-with-gif">
            {{ form.content(rows=2, cols=40) }}
            {% include 'gif_comment.html' %}
          </div>
        </div>

        {{ form.submit(class_='comment-submit') }}
      </form>
      {% else %}
        <p><a href="{{ url_for('login') }}">Log in</a> to leave a comment.</p>
      {% endif %}
    </div>
  </div>
</div>
</main>
{% endblock content %}

{% block scripts %}
<script src="{{ url_for('static', filename='scripts/progress_bar.js') }}"></script>
<script src="{{ url_for('static', filename='scripts/gif_popup.js') }}"></script>
<script src="{{ url_for('static', filename='scripts/comments.js') }}"></script>
{% endblock scripts %}
