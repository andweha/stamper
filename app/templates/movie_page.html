{% extends "layout.html" %}
{% block content %}
<div class="Container">
  <div class="Details">

    <div class="title-poster">
        <h2>{{ movie.title }}</h2>
        {% if movie.poster_url %}
            <img src="{{ movie.poster_url }}" alt="{{ movie.title }}">
        {% endif %}
    </div> <!-- Title poster ends here-->
    <div class="Overview">
    <p>{{ movie.overview }}</p>
    <p><strong>Air Date:</strong> {{ movie.release_date }}</p>
    <p><strong>Rating:</strong> {{ movie.vote_average }}</p>
    </div> <!-- Overview ends here-->


  </div><!-- Movie Details div ends here
  
  
  -->
    <hr>
<!-- Fake playback bar -->


{% if current_user.is_authenticated %}
  <h3>Add a Comment</h3>
  <form method="POST">
    <div id="progress-container"
    class="progress-container"
    data-duration="{{ movie.runtime or 3600 }}">   <!-- total seconds -->
    <div id="progress-bar" class="progress-bar"></div>
    <span id="progress-tooltip" class="progress-tooltip"></span>
    </div>
    {{ form.hidden_tag() }}

    <div>
      <label for="timestamp">{{ form.timestamp.label }}</label><br>
      {{ form.timestamp(size=10, placeholder="e.g., 01:23:45") }}
      {% for error in form.timestamp.errors %}
        <p style="color: red;">{{ error }}</p>
      {% endfor %}
    </div>

    <br>

    <div>
      <label for="content">{{ form.content.label }}</label><br>
      {{ form.content(rows=3, cols=40) }}
      {% for error in form.content.errors %}
        <p style="color: red;">{{ error }}</p>
      {% endfor %}
    </div>

    <br>
    {{ form.submit() }}
  </form>
{% else %}
  <p><a href="{{ url_for('login') }}">Log in</a> to leave a comment.</p>
{% endif %}
<button id="toggle-comments" class="toggle-btn">Show Comments</button>



<hr>


<h2>Comments</h2>
<div id="comments-container" class="comments-container hidden">
  {% if comments %}
    {% for comment in comments %}
      {% set hrs = comment.timestamp // 3600 %}
      {% set mins = (comment.timestamp % 3600) // 60 %}
      {% set secs = comment.timestamp % 60 %}
      <div class="comment">
        <div class="comment-header">
          <strong>{{ comment.user.username }}</strong> at
          <code>{{ "%02d:%02d:%02d"|format(hrs, mins, secs) }}</code>
        </div>
        <div class="comment-body">
          {{ comment.content }}
        </div>
      </div>
    {% endfor %}  <!-- there was a random end div here -->
  {% else %}
    <p>No comments yet.</p>
  {% endif %}
</div> <!-- comments-container end-->



</div> <!-- Main container end-->
{% endblock content %}

{% block scripts %}
<script>
(() => {
  document.addEventListener('DOMContentLoaded', () => {
  const container = document.getElementById('progress-container');
  if (!container) return;

  const tooltip = document.getElementById('progress-tooltip');
  const tsInput = document.getElementById('timestamp');  // ← actual input
  const duration = parseInt(container.dataset.duration, 10) || 0;

  /* seconds → HH:MM:SS */
  const fmt = s => {
    s = Math.round(s);
    const h = String(Math.floor(s / 3600)).padStart(2,'0');
    const m = String(Math.floor((s % 3600) / 60)).padStart(2,'0');
    const sec = String(s % 60).padStart(2,'0');
    return `${h}:${m}:${sec}`;
  };

  container.addEventListener('mousemove', e => {
    const rect = container.getBoundingClientRect();
    const pct  = (e.clientX - rect.left) / rect.width;
    tooltip.style.left  = `${e.clientX - rect.left}px`;
    tooltip.textContent = fmt(pct * duration);
    tooltip.style.display = 'block';
  });

  container.addEventListener('click', e => {
    if (!tsInput) return;
    const rect = container.getBoundingClientRect();
    const pct  = (e.clientX - rect.left) / rect.width;
    tsInput.value = fmt(pct * duration);   // fill the input
    tsInput.focus();
  });

  container.addEventListener('mouseleave', () => {
    tooltip.style.display = 'none';
  });


const commentsContainer = document.getElementById('comments-container');
const toggleBtn = document.getElementById('toggle-comments');

if (toggleBtn && commentsContainer) {
  toggleBtn.addEventListener('click', () => {
    // flip the `.hidden` switch
    commentsContainer.classList.toggle('hidden');

    // update button text
    const nowHidden = commentsContainer.classList.contains('hidden');
    toggleBtn.textContent = nowHidden ? 'Show Comments' : 'Hide Comments';
  });
  };
});
})();
</script>
{% endblock scripts %}