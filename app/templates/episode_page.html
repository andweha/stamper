{% extends "layout.html" %}

{% block content %}
<div class="container">
    <h2>Episode {{ episode.episode_number }}: {{ episode.episode_name }}</h2>
    {% if episode.still_url %}
        <img src="{{ episode.still_url }}" alt="{{ episode.episode_name }}">
    {% endif %}
    <p>{{ episode.overview }}</p>
    <p><strong>Air Date:</strong> {{ episode.air_date }}</p>
    <p><strong>Rating:</strong> {{ episode.vote_average }}</p>

    <hr>

    <!-- Fake playback bar -->
    <div id="progress-container"
        class="progress-container"
        data-duration="{{ item.runtime_seconds or 3600 }}">   <!-- total seconds -->
      <div id="progress-bar" class="progress-bar"></div>
      <span id="progress-tooltip" class="progress-tooltip"></span>
    </div>

    <div id="comments-container" class="comments-container hidden">
        <h2>Comments</h2>
        {% if comments %}
          {% for comment in comments %}
            {% set hrs = comment.timestamp // 3600 %}
            {% set mins = (comment.timestamp % 3600) // 60 %}
            {% set secs = comment.timestamp % 60 %}
            <div class="comment">
              <div class="comment-header">
                <strong>{{ comment.user.username }}</strong> at
                <code>{{ "%02d:%02d:%02d"|format(hrs, mins, secs) }}</code>
              </div>
              <div class="comment-body">
                {{ comment.content }}
              </div>
            </div>
          {% endfor %}  <!-- there was a random end div here -->
        {% else %}
          <p>No comments yet.</p>
        {% endif %}
    </div>

    <hr>

    {% if current_user.is_authenticated %}
      <h3>Add a Comment</h3>
      <form method="POST">
        {{ form.hidden_tag() }}

        <div>
          <label for="timestamp">{{ form.timestamp.label }}</label><br>
          {{ form.timestamp(size=10, placeholder="e.g., 01:23:45") }}
          {% for error in form.timestamp.errors %}
            <p style="color: red;">{{ error }}</p>
          {% endfor %}
        </div>

        <br>

        <div>
          <label for="content">{{ form.content.label }}</label><br>
          {{ form.content(rows=3, cols=40) }}
          {% for error in form.content.errors %}
            <p style="color: red;">{{ error }}</p>
          {% endfor %}
        </div>

        <br>
        {{ form.submit() }}
      </form>
    {% else %}
      <p><a href="{{ url_for('login') }}">Log in</a> to leave a comment.</p>
    {% endif %}
    <button id="toggle-comments" class="toggle-btn">Show Comments</button>
</div>
{% endblock content %}


{% block scripts %}
<script>
(() => {
  const container = document.getElementById('progress-container');
  if (!container) return;

  const tooltip = document.getElementById('progress-tooltip');
  const tsInput = document.getElementById('timestamp');  // ← actual input
  const duration = parseInt(container.dataset.duration, 10) || 0;

  /* seconds → HH:MM:SS */
  const fmt = s => {
    s = Math.round(s);
    const h = String(Math.floor(s / 3600)).padStart(2,'0');
    const m = String(Math.floor((s % 3600) / 60)).padStart(2,'0');
    const sec = String(s % 60).padStart(2,'0');
    return `${h}:${m}:${sec}`;
  };

  container.addEventListener('mousemove', e => {
    const rect = container.getBoundingClientRect();
    const pct  = (e.clientX - rect.left) / rect.width;
    tooltip.style.left  = `${e.clientX - rect.left}px`;
    tooltip.textContent = fmt(pct * duration);
    tooltip.style.display = 'block';
  });

  container.addEventListener('click', e => {
    if (!tsInput) return;
    const rect = container.getBoundingClientRect();
    const pct  = (e.clientX - rect.left) / rect.width;
    tsInput.value = fmt(pct * duration);   // fill the input
    tsInput.focus();
  });

  container.addEventListener('mouseleave', () => {
    tooltip.style.display = 'none';
  });


  const commentsContainer = document.getElementById('comments-container');
  const toggleBtn = document.getElementById('toggle-comments');

  if (toggleBtn && commentsContainer) {
    toggleBtn.addEventListener('click', () => {
      const hidden = commentsContainer.style.display === 'none';
      commentsContainer.style.display = hidden ? '' : 'none';
      toggleBtn.textContent = hidden ? 'Hide Comments' : 'Show Comments';
    });
  }
})();
</script>
{% endblock scripts %}